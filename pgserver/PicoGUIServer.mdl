# -*- python -*-

import os
from beeconfig import compile, distrib, install, clean

multicompile     = 1
platform_variant = 1

help = """
Provides the PicoGUI server, which is responsible for the
graphical interface.
"""

depends = [ 'kernel', 'resourcemanager' ]

runtime = [

            Runtime ('install', 'Install PicoGUI Server',
                     content = [ 'bin/pgserver',
                                 'etc/pgserver.conf'],
                     depends = [ 'resourcemanager/install' ],
                     help = "Install the PicoGUI Server" ),

            Runtime ('server', 'Run PicoGUI Server',

                     content = [ 'etc/rm.d/picoguiserver' ],
                     
                     depends = [ 'picoguiserver/install',
                                 'pocketapps/bioscall',
                                 'resourcemanager/server',
                                 'pocketapps/initenv',
                                 'pocketapps/remorakb_checker',
                                 ],
                     rcscript = '''
# setup env vars
echo  >/var/pgserver.dynconf "[pgserver]"

# pre-calibrate the /dev/ts device using bios env var
bioscall --ts-calibrate=PG_TS_CALIBRATION

if bioscall --test PG_REMORAKB_ON -eq 1
then
  echo "/etc/rc: Using Remora keyboard on ttyS0"
  remorakb_checker --force=0 >>/var/pgserver.dynconf
  if bioscall --test PG_REMORAKB_BAUD_SHIFT -eq 1
  then
    echo "baud_shift = 1" >>/var/pgserver.dynconf
  fi
fi

# start pgserver
rm_task unblock picogui-server

''',
                     help = "Start the PicoGUI Server" )
            ]


def prepare (module, platform, project):
    profile = "../profiles/profile.SMARTDATA-m68k-pic-coff-%s" % platform.feature ['variant']
    
    command = ("../configure --prefix=%s --with-profile=%s --with-prefix --host=%s " +
               "--with-extra-ipath=%s/include:%s/include --with-extra-libs=%s/lib/librm.a " +
               "--with-rpm-prefix=%s --with-rpm-platform=%s --enable-bee") % \
              (module.install_path (platform, project),
               profile,
               platform.feature ['platform'],
               project.modules ['kernel'].install_path (platform, project),
               project.modules ['resourcemanager'].install_path (platform, project),
               project.modules ['resourcemanager'].install_path (platform, project),
               module.install_path (platform, project, standard = 1),
               platform.fqn ())

    message ("running: %s" % command)
    sequence ("test ! -f ../autogen.sh || (cd .. ; ./autogen.sh || true)", command)
    return


def compile (module, platform, project):
    sequence ("make")
    return


def install (module, platform, project):
    sequence ("make install prefix=%s" % module.path ['frz'])

    # try to install the mdl file in the root of the frozen directory
    mdl = module.file
    if os.path.isfile (mdl):
        installfile (mdl, module.path ['r_frz'])

    # generate the RM file
    file = os.path.join (module.path ['frz'], 'etc', 'rm.d', 'picoguiserver')
    makedirs (os.path.dirname (file))

    fd = open (file, 'w')
    fd.write ('''
name = picogui-server
argv = pgserver

restart   = 0
announce  = 1
can-block = 1
    ''')
    fd.close ()
    return



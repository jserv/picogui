/*
 * Simple image viewer, using a smidgen of custom themeing
 *
 * -- Micah Dowty <micahjd@users.sourceforge.net>
 */

#include <picogui.h>
#include <string.h>

pghandle panel, bitmapwidget;

/* This is our custom theme, generated from the following source:
 * (i used the pnmembed script included with pgserver
 *  to convert it to C code)
 *
 * object "imgview.panel" {
 *  margin = 0;
 *  bitmap1 = LoadBitmap("checker.bmp");
 *  bgfill = fillstyle {
 *    Bitmap(x,y,w,h,bitmap1);
 *  };
 * }
 *
 * And in this case, checker.bmp is a cropped screenshot from gimp :)
 *
 */
unsigned char paneltheme_bits[] = {
0x50, 0x47, 0x74, 0x68, 0x00, 0x00, 0x01, 0x38, 0x00, 0x00, 
0x51, 0xBA, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x04, 
0x7F, 0xFF, 0x00, 0x04, 0x00, 0x00, 0x00, 0x1C, 0x00, 0x03, 
0x00, 0x01, 0x00, 0x00, 0x00, 0x58, 0x00, 0x06, 0x00, 0x01, 
0x00, 0x00, 0x00, 0x3C, 0x00, 0x09, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x10, 0x00, 0x01, 0x00, 0x00, 0x00, 0x6C, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0D, 0x00, 0x05, 
0x00, 0x00, 0x69, 0x6D, 0x67, 0x76, 0x69, 0x65, 0x77, 0x2E, 
0x70, 0x61, 0x6E, 0x65, 0x6C, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x0E, 0x00, 0x00, 
0x10, 0x11, 0x12, 0x13, 0x2D, 0x00, 0x10, 0x94, 0x00, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x00, 0xBE, 0x00, 0x03, 0x00, 0x00, 
0x42, 0x4D, 0xBE, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
0x3E, 0x00, 0x00, 0x00, 0x28, 0x00, 0x00, 0x00, 0x20, 0x00, 
0x00, 0x00, 0x20, 0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 
0x00, 0x00, 0x00, 0x00, 0x80, 0x00, 0x00, 0x00, 0x61, 0x0B, 
0x00, 0x00, 0x61, 0x0B, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 
0x02, 0x00, 0x00, 0x00, 0x66, 0x66, 0x66, 0x00, 0x99, 0x99, 
0x99, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 
0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 
0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 
0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 
0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 
0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 
0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 
0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 
0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 
0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 
0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 
0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 
0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0xFF, 
0x00, 0x00, 
};
#define paneltheme_len 312

void load_bitmap(const char *filename) {
  int w,h;
  pghandle bitmap;
  const char *name;

  /* Delete old bitmap */
  pgDelete(pgGetWidget(bitmapwidget, PG_WP_BITMAP));

  /* Find the actual name of the file */
  name = strrchr(filename,'/');
  if (name)
    name++;
  else
    name = filename;
  
  bitmap = pgNewBitmap(pgFromFile(filename));
  pgSizeBitmap(&w,&h,bitmap);
  pgReplaceTextFmt(panel,"%s - %dx%d Image",name,w,h);
  pgSetWidget(bitmapwidget,PG_WP_BITMAP, bitmap,0);
}

int btnOpen(struct pgEvent *evt) {
  const char *s;
  
  s = pgFilePicker(NULL,NULL,NULL,PG_FILEOPEN,"Open an Image");
  if (s)
    load_bitmap(s);
  return 0;
}

int main(int argc, char **argv) {
  pghandle titleLabel,scroll,box;
  
  pgInit(argc,argv);
  pgLoadTheme(pgFromMemory(paneltheme_bits,paneltheme_len));

  panel = pgRegisterApp(PG_APP_NORMAL,"Image Viewer",0);
  pgSetWidget(PGDEFAULT,
	      PG_WP_THOBJ, pgFindThemeObject("imgview.panel"),
	      0);

  scroll = pgNewWidget (PG_WIDGET_SCROLL, 0, 0);
  box = pgNewWidget (PG_WIDGET_BOX, 0, 0);
  pgSetWidget(PGDEFAULT,
	      PG_WP_THOBJ, pgFindThemeObject("imgview.panel"),
	      0);
  pgSetWidget (scroll, PG_WP_BIND, box, 0);
  

  bitmapwidget = pgNewWidget(PG_WIDGET_BITMAP,PG_DERIVE_INSIDE,box);
  
  titleLabel = pgGetWidget(panel, PG_WP_PANELBAR_LABEL);

  pgNewWidget(PG_WIDGET_BUTTON, PG_DERIVE_BEFORE, titleLabel);
  pgSetWidget(PGDEFAULT,
	      PG_WP_SIDE, PG_S_LEFT,
	      PG_WP_TEXT, pgNewString("Open"),
	      0);
  pgBind(PGDEFAULT, PG_WE_ACTIVATE, btnOpen, &bitmapwidget);

  if (argc > 1)
    load_bitmap(argv[1]);
 
  pgEventLoop();
  return 0;
}





/* The End */

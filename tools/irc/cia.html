<html>
  <head>
    <title>Setting up your project for CIA commit monitoring</title>
  </head>

  <body>
    <h1>What is CIA?</h1>
    <p>CIA is a bot that will take email from your CVS/Subversion repositories' commit scripts, and output it to the
      #commits channel on freenode, and optionally to your project's IRC channel.
      It means you can sit in that channel and marvel in real time at all the free software
      being written all over the world.</p>

    <h1>Using it with CVS</h1>

    <p>For CVS, firstly place this script somewhere on the server:</p>
    <code><pre>

#!/bin/bash
message=`cat`
uname=`id -un`
lineno=`echo "$message" | grep -n "Log Message:" | awk -F: ' { print $1 } '`
message=`echo "$message" | sed "1,${lineno}d"`

projectname="<i><font color="#FF0000">project name</font></i>"
tmpfile="/tmp/$RANDOM-$projectname"

cat &lt;&lt;EOF >$tmpfile
From: commits@<i><font color="#FF0000">project domain</font></i>
To: commits@picogui.org
Content-Type: text/plain;
Subject: Announce $projectname

commit by $uname: $message
EOF

if [ -e /tmp/lastlog-$projectname ]; then
        if ! diff /tmp/lastlog-$projectname $tmpfile &>/dev/null; then
                # there are differences, so this is a different commit
                cat $tmpfile | /usr/sbin/sendmail -t
                mv $tmpfile /tmp/lastlog-$projectname
        else
                # it's just cvs spamming us from another directory
                rm $tmpfile
        fi
else
        cat $tmpfile | /usr/sbin/sendmail
        mv $tmpfile /tmp/lastlog-$projectname
fi

    </pre></code>

    <p> Replace all the text in red with values applicable to your project. If your project has an IRC channel on freenode,
        the project name should be the channel name without the leading "#" character. It will be used to prefix the output in #commits
        as well. </p>

    <p> This script strips out all the extra info CVS gives, then compares each log message to the last one sent so that
        it doesn't spam the bot with the same message for every directory in the commit. It then emails the resulting message
        off to the bot. This assumes you're using ssh authentication, otherwise the username will always return the same thing.</p>

    <p> Note that if you're using this on sourceforge you'll need to change the email address from commits@picogui.org to an alias,
        cia@users.sf.net. This is because Sourceforge's CVS server is only allowed to send mail to other sourceforge domains. </p>

    <p> Now check out the CVSROOT module of your projects repository, and in the loginfo file, place this line:</p>

    <code>
      ALL /path/to/script
    </code>

    <h1> Using it with Subversion </h1>

    <p>Place this script in hooks/post-commit under your repository directory: (This is the directory on the server containing the
       repository database, not inside the repository itself) </p>

    <code><pre>
#!/bin/sh
REPOS="$1"
REV="$2"
echo "`svnlook author -r $REV $REPOS`" committed revision $REV: "`svnlook log -r $REV $REPOS`" | \
   head -n 1 | mail -s "Announce <i>channelname</i>" commits@picogui.org&
    </pre></code>

    <p>Substitute the name of your channel, without leading "#" character, for <i>channelname</i>. You can see an example of the
    post-commit script used in the PicoGUI repository <a href="http://navi.picogui.org/svn/picogui/trunk/tools/svn/hooks/">here</a> </p>

    <h1>Controlling the bot</h1>

    <p> You can make the bot join your channel by sending an email to commits@picogui.org with the subject
        "JoinChannel <i>channelname</i>".
        (Leave out the "#" beginning the channel name) You can make it leave your channel by sending a mail with the subject
        "PartChannel <i>channelname</i>". </p> The email body will be ignored.

    <h1> Source code </h1>

    <p>
     <a href="http://navi.picogui.org/svn/picogui/trunk/tools/irc/announceBot.py">The bot</a>, 
     <a href="http://navi.picogui.org/svn/picogui/trunk/tools/irc/emailBotClient.py">The email-based client</a>.
     It falls under the "who cares" license, do anything you like with it. </p>

    <h1> Who wrote this stuff? </h1>
    
    <p> That would be scanline (Micah Dowty), in #picogui. This page is written by TD (Mike Hearn) in #autopackage.</p>

    <h1> Why is it called CIA? </h1>

    <p> Lalo Martins' joke: CIA was originally written to monitor the PicoGUI subversion repository, so the bot is a
      brainless entity designed to monitor subversion. If you don't get it, forget it :) </p>

    <hr>
    <p>1st June 2003</p>
  </body>

</html>
